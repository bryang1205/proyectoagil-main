<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Administraci√≥n - Sistema de Restaurante</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fa; min-height: 100vh; }

    .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;}
    .header h1 { font-size: 1.5rem; font-weight: 600; }
    .btn-back { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; text-decoration: none; transition: all 0.3s;}
    .btn-back:hover { background: rgba(255,255,255,0.3); }
    .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }

    .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; background: white; padding: 0.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .tab { flex: 1; padding: 1rem; background: transparent; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #666;}
    .tab:hover { background: #f8f9fa; }
    .tab.active { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .panel { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .panel-header h2 { color: #2c3e50; font-size: 1.3rem; }
    .btn-primary { padding: 0.7rem 1.5rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.3s;}
    .btn-primary:hover { opacity: 0.9; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; padding: 1rem; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e0e0e0; }
    td { padding: 1rem; border-bottom: 1px solid #f0f0f0; color: #34495e; }
    tr:hover { background: #f8f9fa; }

    .badge { display: inline-block; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
    .badge-disponible { background: #d1ecf1; color: #0c5460; }
    .badge-agotado { background: #fff3cd; color: #856404; }

    .btn-action { padding: 0.4rem 0.8rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; margin: 0 0.25rem; transition: opacity 0.3s; }
    .btn-edit { background: #3498db; color: white; }
    .btn-action:hover { opacity: 0.8; }

    .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
    .table-card { background: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; border-left: 5px solid #27ae60; transition: transform 0.3s, box-shadow 0.3s; }
    .table-card.inactive { border-left-color: #e74c3c; }
    .table-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .table-card-header { display: flex; justify-content: space-between; align-items: center; }
    .table-card-header h3 { font-size: 1.8rem; color: #2c3e50; }
    .table-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #ffffff; }
    .status-disponible { background-color: #27ae60; }
    .status-inactiva { background-color: #e74c3c; }
    .table-card-body { min-height: 20px; }
    .table-card-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #f0f0f0; }
    .table-card-footer .btn { padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h3 { color: #2c3e50; font-size: 1.3rem; }
    .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: #34495e; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #f093fb; }
    .form-actions { display: flex; gap: 0.5rem; margin-top: 1.5rem; }
    .btn-secondary { flex: 1; padding: 0.7rem; background: #95a5a6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-submit { flex: 1; padding: 0.7rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }

    .photo-upload-container { border: 2px dashed #e0e0e0; border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8f9fa; }
    .photo-upload-container:hover { border-color: #f093fb; background: #fff; }
    .photo-upload-container.has-image { border-style: solid; border-color: #f093fb; }
    .photo-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 1rem; display: none; }
    .photo-preview.show { display: block; }
    .upload-icon { font-size: 3rem; color: #bbb; margin-bottom: 0.5rem; }
    .upload-text { color: #666; font-size: 0.9rem; }
    .photo-actions { margin-top: 1rem; display: none; }
    .photo-actions.show { display: block; }
    .btn-remove-photo { background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
    .btn-remove-photo:hover { opacity: 0.8; }

    @media (max-width: 768px) {
      .tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>‚öô Panel de Administraci√≥n</h1>
      <a href="dashboard.html" class="btn-back">‚Üê Volver</a>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('Menu', event)">üçΩ Men√∫</button>
      <button class="tab" onclick="switchTab('Mesas', event)">ü™ë Mesas</button>
    </div>

    <div id="tabMenu" class="tab-content active">
      <div class="panel">
        <div class="panel-header">
          <h2>Gesti√≥n del Men√∫</h2>
          <button class="btn-primary" onclick="openMenuModal()">‚ûï Nuevo Platillo</button>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Platillo</th><th>Categor√≠a</th><th>Precio</th><th>Estado</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="menuTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tabMesas" class="tab-content">
        <div class="panel">
            <div class="panel-header">
                <h2>Gesti√≥n de Mesas</h2>
                <button class="btn-primary" onclick="openMesaModal()">‚ûï Nueva Mesa</button>
            </div>
            <div class="table-grid" id="tableGrid"></div>
        </div>
    </div>
  </div>

  <div id="menuModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="menuModalTitle">Nuevo Platillo</h3>
        <button class="btn-close" onclick="closeMenuModal()">√ó</button>
      </div>
      <form id="menuForm" onsubmit="saveMenuItem(event)">
        <div class="form-group">
          <label>Foto del Platillo</label>
          <div class="photo-upload-container" id="photoUploadContainer" onclick="document.getElementById('photoInput').click()">
            <div id="uploadPlaceholder">
              <div class="upload-icon">üì∏</div>
              <div class="upload-text">Haz clic para seleccionar una foto</div>
              <div class="upload-text" style="font-size: 0.8rem; margin-top: 0.5rem; color: #999;">JPG, PNG o WEBP (m√°x. 5MB)</div>
            </div>
            <img id="photoPreview" class="photo-preview" alt="Vista previa">
          </div>
          <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
          <div class="photo-actions" id="photoActions">
            <button type="button" class="btn-remove-photo" onclick="removePhoto(event)">üóë Eliminar foto</button>
          </div>
        </div>
        <div class="form-group"> <label>Nombre</label> <input type="text" name="nombre" required> </div>
        <div class="form-group">
          <label>Categor√≠a</label>
          <select name="categoria" required>
            <option value="" disabled selected>Seleccione</option>
            <option value="entradas">Entradas</option>
            <option value="platos principales">Platos Principales</option>
            <option value="postres">Postres</option>
            <option value="bebidas">Bebidas</option>
          </select>
        </div>
        <div class="form-group"> <label>Precio (S/)</label> <input type="number" name="precio" step="0.01" min="0" required> </div>
        <div class="form-group"> <label>Descripci√≥n</label> <textarea name="descripcion" rows="3" required></textarea> </div>
        <div class="form-group"> <label>Cantidad</label> <input type="number" name="cantidad" min="0" value="0" required> </div>
        <div class="form-group">
          <label>Estado</label>
          <select name="disponible" required>
            <option value="true">Disponible</option>
            <option value="false">Agotado</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeMenuModal()">Cancelar</button>
          <button type="submit" class="btn-submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="mesaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="mesaModalTitle">Nueva Mesa</h3>
        <button class="btn-close" onclick="closeMesaModal()">√ó</button>
      </div>
      <form id="mesaForm" onsubmit="saveMesa(event)">
        <div class="form-group">
          <label for="mesaNumber">N√∫mero de Mesa (ID)</label>
          <input type="number" id="mesaNumber" required min="0">
        </div>
        <div class="form-group">
          <label for="mesaState">Estado</label>
          <select id="mesaState" required>
            <option value="Disponible">Disponible</option>
            <option value="Inactiva">Inactiva</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-secondary" onclick="closeMesaModal()">Cancelar</button>
          <button type="submit" class="btn-submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

<script>
    // --- ESTADO GLOBAL Y CONFIGURACI√ìN ---
    const API_BASE_URL = "http://localhost:8082";
    let editingMenuId = null;
    let selectedPhotoFile = null;
    let menuItems = []; 
    let tables = []; // Almacenar√° las mesas tra√≠das de la API
    let editingMesaId = null;

    // --- GESTI√ìN DE MEN√ö (CONECTADO AL BACKEND) ---
    async function loadMenu() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/productos`);
        menuItems = await response.json();
        const tableBody = document.getElementById("menuTable");
        tableBody.innerHTML = menuItems.map(item => `
          <tr>
            <td><strong>${item.nombre}</strong></td>
            <td>${item.categoria.nombre}</td>
            <td>S/ ${item.precio.toFixed(2)}</td>
            <td>
              <span class="badge badge-${item.cantidad > 0 ? 'disponible' : 'agotado'}">
                ${item.cantidad > 0 ? 'Disponible' : 'Agotado'}
              </span>
            </td>
            <td><button class="btn-action btn-edit" onclick="editMenuItem('${item.nombre}')">‚úè Editar</button></td>
          </tr>
        `).join("");
      } catch (error) {
        console.error("Error al cargar el men√∫:", error);
        alert("No se pudo cargar el men√∫. Revisa la consola para m√°s detalles.");
      }
    }

    async function saveMenuItem(event) {
      event.preventDefault();
      const form = event.target;
      const nombrePlatillo = form.nombre.value.trim();

      const formData = new FormData();
      if (selectedPhotoFile) formData.append('imagen', selectedPhotoFile);
      formData.append('nombre', nombrePlatillo);
      formData.append('categoria', form.categoria.value);
      formData.append('precio', form.precio.value);
      formData.append('descripcion', form.descripcion.value);
      formData.append('cantidadDisponible', form.cantidad.value);

      const url = editingMenuId 
        ? `${API_BASE_URL}/api/productos/editar/${encodeURIComponent(editingMenuId)}`
        : `${API_BASE_URL}/api/productos`;
      
      const method = editingMenuId ? "PUT" : "POST";

      try {
        const response = await fetch(url, { method, body: formData });
        if (response.ok) {
          alert(`Platillo ${editingMenuId ? 'actualizado' : 'creado'} exitosamente`);
          loadMenu();
          closeMenuModal();
        } else {
          const err = await response.json();
          alert("Error: " + (err.error || "No se pudo guardar el platillo"));
        }
      } catch (error) {
        console.error("Error al guardar el platillo:", error);
        alert("Error al guardar. Verifica tu conexi√≥n con el servidor.");
      }
    }
    
    // (Las funciones de men√∫ auxiliares como editMenuItem, open/close modals y manejo de fotos no cambian)
    async function editMenuItem(nombreExistente) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/productos/buscar/${encodeURIComponent(nombreExistente)}`);
        if (!response.ok) { alert("No se encontr√≥ el producto"); return; }
        const producto = await response.json();
        editingMenuId = producto.nombre;
        const form = document.getElementById('menuForm');
        form.nombre.value = producto.nombre;
        form.categoria.value = producto.categoria.nombre;
        form.precio.value = producto.precio;
        form.descripcion.value = producto.descripcion;
        form.cantidad.value = producto.cantidad || 0;
        if (producto.imagenUrl) {
          const preview = document.getElementById('photoPreview');
          const placeholder = document.getElementById('uploadPlaceholder');
          const container = document.getElementById('photoUploadContainer');
          const actions = document.getElementById('photoActions');
          preview.src = `${API_BASE_URL}${producto.imagenUrl}`;
          preview.classList.add('show');
          placeholder.style.display = 'none';
          container.classList.add('has-image');
          actions.classList.add('show');
        }
        document.getElementById('menuModalTitle').textContent = `Editar Platillo: ${producto.nombre}`;
        document.getElementById('menuModal').classList.add('active');
      } catch (error) { console.error("Error al cargar el producto:", error); }
    }
    function openMenuModal() {
      editingMenuId = null;
      selectedPhotoFile = null;
      document.getElementById('menuModalTitle').textContent = 'Nuevo Platillo';
      document.getElementById('menuForm').reset();
      removePhoto({ stopPropagation: () => {} });
      document.getElementById('menuModal').classList.add('active');
    }
    function closeMenuModal() {
      document.getElementById('menuModal').classList.remove('active');
      removePhoto({ stopPropagation: () => {} });
    }
    function handlePhotoSelect(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/') || file.size > 5 * 1024 * 1024) {
            alert('Archivo no v√°lido (debe ser imagen de < 5MB)'); return;
        }
        selectedPhotoFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            const preview = document.getElementById('photoPreview');
            document.getElementById('uploadPlaceholder').style.display = 'none';
            document.getElementById('photoUploadContainer').classList.add('has-image');
            document.getElementById('photoActions').classList.add('show');
            preview.src = e.target.result;
            preview.classList.add('show');
        };
        reader.readAsDataURL(file);
    }
    function removePhoto(event) {
        event.stopPropagation();
        selectedPhotoFile = null;
        document.getElementById('photoInput').value = '';
        document.getElementById('photoPreview').src = '';
        document.getElementById('photoPreview').classList.remove('show');
        document.getElementById('uploadPlaceholder').style.display = 'block';
        document.getElementById('photoUploadContainer').classList.remove('has-image');
        document.getElementById('photoActions').classList.remove('show');
    }

    // --- GESTI√ìN DE MESAS (CONECTADO AL BACKEND - MODIFICADO) ---
    async function loadMesas() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/mesas`);
        if (!response.ok) throw new Error('No se pudo obtener la lista de mesas.');
        
        tables = await response.json(); // Guardamos los datos en el array global
        const tableGrid = document.getElementById('tableGrid');
        tableGrid.innerHTML = tables.sort((a, b) => a.idMesa - b.idMesa).map(mesa => {
            const statusClass = mesa.estado === 'Inactiva' ? 'status-inactiva' : 'status-disponible';
            const cardClass = mesa.estado === 'Inactiva' ? 'inactive' : '';
            return `
            <div class="table-card ${cardClass}">
                <div class="table-card-header">
                    <h3>Mesa ${mesa.idMesa}</h3>
                    <span class="table-status ${statusClass}">${mesa.estado}</span>
                </div>
                <div class="table-card-footer">
                    <button class="btn-action btn-edit" onclick="openMesaModal(${mesa.idMesa})">‚úèÔ∏è Editar</button>
                </div>
            </div>
            `;
        }).join('');
      } catch (error) {
        console.error("Error al cargar las mesas:", error);
        alert("No se pudo conectar al servidor para cargar las mesas.");
      }
    }

    function openMesaModal(idMesa = null) {
      const modal = document.getElementById('mesaModal');
      const modalTitle = document.getElementById('mesaModalTitle');
      const form = document.getElementById('mesaForm');
      const numberInput = document.getElementById('mesaNumber');
      form.reset();
      
      if (idMesa) { // Editando una mesa existente
        const mesa = tables.find(t => t.idMesa === idMesa);
        if (!mesa) return;
        
        editingMesaId = idMesa;
        modalTitle.textContent = `Editar Mesa ${mesa.idMesa}`;
        numberInput.value = mesa.idMesa;
        numberInput.disabled = true; // El ID no se debe cambiar
        document.getElementById('mesaState').value = mesa.estado;
      } else { // Creando una nueva mesa
        editingMesaId = null;
        modalTitle.textContent = 'Crear Nueva Mesa';
        numberInput.disabled = false;
      }
      modal.classList.add('active');
    }

    function closeMesaModal() {
      document.getElementById('mesaModal').classList.remove('active');
    }

    async function saveMesa(event) {
        event.preventDefault();
        const numeroMesa = parseInt(document.getElementById('mesaNumber').value);
        const estadoMesa = document.getElementById('mesaState').value;
        
        const mesaData = {
            idMesa: numeroMesa,
            estado: estadoMesa
        };

        const isEditing = editingMesaId !== null;
        const url = isEditing 
            ? `${API_BASE_URL}/api/mesas/${editingMesaId}` 
            : `${API_BASE_URL}/api/mesas`;
        
        const method = isEditing ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(mesaData)
            });

            if (response.ok) {
                alert(`Mesa ${isEditing ? 'actualizada' : 'creada'} correctamente.`);
                closeMesaModal();
                loadMesas(); // Recargar las mesas para mostrar los cambios
            } else {
                // Idealmente, el backend devolver√≠a un error espec√≠fico
                alert('Error al guardar la mesa. Es posible que el ID ya exista.');
            }
        } catch (error) {
            console.error('Error de red al guardar la mesa:', error);
            alert('No se pudo conectar al servidor para guardar la mesa.');
        }
    }


    // --- L√ìGICA DE NAVEGACI√ìN Y UTILIDADES ---
    function switchTab(tabName, event) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`tab${tabName}`).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    window.onload = () => {
        loadMenu();
        loadMesas();
    };
</script>
</body>
</html>