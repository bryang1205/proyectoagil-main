<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n de Pedidos - Restaurante</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7fa; min-height: 100vh; }

    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.5rem; font-weight: 600; }
    .btn-back { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; text-decoration: none; transition: all 0.3s; }
    .btn-back:hover { background: rgba(255,255,255,0.3); }

    .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; display: grid; grid-template-columns: 1fr 400px; gap: 2rem; }
    .order-form, .order-summary { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .order-summary { height: fit-content; position: sticky; top: 2rem; }
    .form-section { margin-bottom: 2rem; }
    .form-section h3 { color: #2c3e50; margin-bottom: 1rem; font-size: 1.1rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: #34495e; font-weight: 500; font-size: 0.95rem; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.7rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: border-color 0.3s; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }

    .cart-items { margin-top: 1rem; }
    .cart-item { display: grid; grid-template-columns: 1fr auto; gap: 0.75rem 1rem; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 0.75rem; }
    .cart-item-info { }
    .cart-item-name { font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem; }
    .cart-item-price { color: #667eea; font-size: 0.9rem; }
    .cart-item-controls { display: flex; align-items: center; gap: 0.5rem; justify-self: end; }
    .btn-qty { width: 30px; height: 30px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: opacity 0.3s; }
    .btn-qty:hover { opacity: 0.8; }
    .item-qty { min-width: 30px; text-align: center; font-weight: 600; }
    .btn-remove { background: #e74c3c; color: white; border: none; padding: 0.4rem 0.7rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-left: 0.5rem; }

    .nota-input { width: 100%; margin-top: 0.4rem; border: 2px dashed #ddd; }
    .nota-hint { font-size: 0.8rem; color: #888; margin-top: 0.25rem; }

    .btn-add-more { width: 100%; padding: 0.8rem; background: #f0f0f0; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer; color: #666; font-weight: 600; transition: all 0.3s; }
    .btn-add-more:hover { background: #e8e8e8; border-color: #667eea; color: #667eea; }

    .order-summary h3 { color: #2c3e50; margin-bottom: 1.5rem; }
    .summary-line { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0; }
    .summary-line.total { border-bottom: none; border-top: 2px solid #667eea; margin-top: 0.5rem; padding-top: 1rem; font-size: 1.2rem; font-weight: 700; color: #667eea; }

    .btn-submit { width: 100%; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1.5rem; transition: opacity 0.3s; }
    .btn-submit:hover { opacity: 0.9; }
    .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

    .empty-cart { text-align: center; padding: 3rem 2rem; color: #7f8c8d; }
    .empty-cart-icon { font-size: 4rem; margin-bottom: 1rem; }

    @media (max-width: 968px) {
      .container { grid-template-columns: 1fr; }
      .order-summary { position: static; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üõí Registrar Pedidos</h1>
      <a href="dashboard.html" class="btn-back">‚Üê Volver</a>
    </div>
  </div>

  <div class="container">
    <!-- Formulario -->
    <div class="order-form">
      <div class="form-section">
        <h3>Datos del Pedido</h3>

        <div class="form-group">
          <label for="tipoPedido">Tipo de Pedido</label>
          <select id="tipoPedido" onchange="onTipoChange()">
            <option value="mesa" selected>ü™ë Para Mesa</option>
            <option value="llevar">üì¶ Para Llevar</option>
          </select>
        </div>

        <div class="form-group" id="mesaGroup">
          <label for="numeroMesa">N√∫mero de Mesa</label>
          <select id="numeroMesa">
            <option value="">Cargando mesas...</option>
          </select>
        </div>
      </div>

      <div class="form-section">
        <h3>Productos del Pedido</h3>
        <div class="cart-items" id="cartItems"></div>
        <button class="btn-add-more" onclick="goToMenu()">‚ûï Agregar m√°s productos</button>
      </div>
    </div>

    <!-- Resumen -->
    <div class="order-summary">
      <h3>Resumen del Pedido</h3>
      <div id="summaryContent"></div>
      <button class="btn-submit" id="btnSubmit" onclick="submitOrder()">Confirmar Pedido</button>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8082";
    let cart = [];              // [{ nombre, precio, cantidad, nota?, idProducto?, stock? }]
    let productosCache = {};    // nombre -> { idProducto, precio, stock, categoria, ... }

    // -------------------- Utilidades --------------------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const soloLetrasEspacios = (str) => /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ú√º√ë√± ]*$/.test(str || "");
    function money(n){ return (Number(n)||0).toFixed(2); }

    // -------------------- Mesas --------------------
    async function loadMesas() {
      const sel = document.getElementById('numeroMesa');
      try {
        const res = await fetch(`${API_BASE}/api/mesas`);
        const mesas = await res.json(); // [{idMesa, estado}, ...]
        // Mostrar solo mesas (incluye 0 si existe en BD; si no, agregamos manualmente si est√°s usando mesa 0)
        const opts = mesas
          .sort((a,b)=>a.idMesa-b.idMesa)
          .map(m => `<option value="${m.idMesa}">Mesa ${m.idMesa} (${m.estado})</option>`)
          .join('');
        sel.innerHTML = `<option value="">Seleccione una mesa</option>${opts}`;
      } catch (err) {
        console.error("Error cargando mesas", err);
        sel.innerHTML = `<option value="">No se pudieron cargar las mesas</option>`;
      }
    }

    function onTipoChange() {
      const tipo = document.getElementById('tipoPedido').value;
      const mesaGroup = document.getElementById('mesaGroup');
      if (tipo === 'llevar') {
        mesaGroup.style.display = 'block'; // seguimos mostrando, pero si quieres ocultar, pon 'none'
        // Si quieres forzar mesa 0 autom√°ticamente:
        setTimeout(()=> {
          const sel = document.getElementById('numeroMesa');
          const tieneMesa0 = Array.from(sel.options).some(o => o.value === "0");
          if (tieneMesa0) sel.value = "0";
        }, 0);
      } else {
        mesaGroup.style.display = 'block';
      }
    }

    // -------------------- Carrito --------------------
    function loadCart() {
      const savedCart = sessionStorage.getItem('cart');
      if (savedCart) {
        try { cart = JSON.parse(savedCart) || []; } catch { cart = []; }
      }
    }

    async function enrichCartWithBackend() {
      // Para cada item en carrito, consultamos /api/productos/buscar/{nombre} para idProducto y stock (cantidad disponible)
      const enriched = await Promise.all(cart.map(async (item) => {
        const nombre = item.nombre;
        if (productosCache[nombre]) {
          const cached = productosCache[nombre];
          return { ...item, idProducto: cached.idProducto, precio: cached.precio ?? item.precio, stock: cached.cantidad ?? cached.stock ?? 0 };
        }
        try {
          const resp = await fetch(`${API_BASE}/api/productos/buscar/${encodeURIComponent(nombre)}`);
          if (!resp.ok) throw new Error('No encontrado');
          const prod = await resp.json();
          // Adaptar a tu ProductoResponse (idProducto, nombre, categoria, precio, descripcion, cantidad)
          const detalle = {
            idProducto: prod.idProducto ?? prod.id_producto ?? prod.id, // fallback
            precio: prod.precio,
            cantidad: prod.cantidad ?? (prod.inventario?.cantDispo || 0)
          };
          productosCache[nombre] = { idProducto: detalle.idProducto, precio: detalle.precio, cantidad: detalle.cantidad };
          return { ...item, idProducto: detalle.idProducto, precio: detalle.precio, stock: detalle.cantidad };
        } catch (e) {
          console.warn("No se pudo enriquecer producto:", nombre, e);
          return { ...item, stock: item.stock ?? 0 }; // no bloquear, pero sin stock no permitir√° aumentar
        }
      }));
      cart = enriched;
      persistCart();
    }

    function persistCart(){ sessionStorage.setItem('cart', JSON.stringify(cart)); }

    function updateCartDisplay() {
      const cartItems = document.getElementById('cartItems');
      const btnSubmit = document.getElementById('btnSubmit');

      if (!cart.length) {
        cartItems.innerHTML = `
          <div class="empty-cart">
            <div class="empty-cart-icon">üõí</div>
            <p>No hay productos en el pedido</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agrega productos desde el men√∫</p>
          </div>`;
        btnSubmit.disabled = true;
        updateSummary();
        return;
      }

      btnSubmit.disabled = false;

      cartItems.innerHTML = cart.map((item, idx) => `
        <div class="cart-item">
          <div class="cart-item-info">
            <div class="cart-item-name">${item.nombre}</div>
            <div class="cart-item-price">S/ ${money(item.precio)} c/u ‚Ä¢ Stock: ${item.stock ?? 0}</div>

            <input class="nota-input" type="text" placeholder="Nota (opcional, ej: sin aji)"
                   value="${item.nota ? item.nota.replace(/"/g,'&quot;') : ''}"
                   oninput="onNotaChange(${idx}, this.value)" maxlength="50" />
            <div class="nota-hint">Solo letras y espacios, m√°x. 50 caracteres.</div>
          </div>

          <div class="cart-item-controls">
            <button class="btn-qty" onclick="decreaseQty(${idx})">‚àí</button>
            <span class="item-qty">${item.cantidad}</span>
            <button class="btn-qty" onclick="increaseQty(${idx})">+</button>
            <button class="btn-remove" onclick="removeItem(${idx})">üóë</button>
          </div>
        </div>
      `).join('');

      updateSummary();
    }

    function onNotaChange(index, value){
      if (!soloLetrasEspacios(value)) {
        // limpieza en vivo: elimina caracteres no permitidos
        value = value.replace(/[^A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ú√º√ë√± ]+/g, '');
      }
      cart[index].nota = value;
      persistCart();
    }

    function increaseQty(index) {
      const item = cart[index];
      const stock = Number(item.stock) || 0;
      const actual = Number(item.cantidad) || 0;
      if (actual + 1 > stock) {
        alert(`No puedes exceder el stock disponible (${stock}).`);
        return;
      }
      item.cantidad = actual + 1;
      persistCart();
      updateCartDisplay();
    }

    function decreaseQty(index) {
      const item = cart[index];
      const actual = Number(item.cantidad) || 0;
      if (actual > 1) {
        item.cantidad = actual - 1;
      } else {
        cart.splice(index, 1);
      }
      persistCart();
      updateCartDisplay();
    }

    function removeItem(index) {
      if (confirm('¬øEliminar este producto del pedido?')) {
        cart.splice(index, 1);
        persistCart();
        updateCartDisplay();
      }
    }

    function updateSummary() {
      const summaryContent = document.getElementById('summaryContent');
      if (!cart.length) {
        summaryContent.innerHTML = '<p style="color: #7f8c8d; text-align: center;">Carrito vac√≠o</p>';
        return;
      }

      const subtotal = cart.reduce((sum, it) => sum + (Number(it.precio) * Number(it.cantidad)), 0);
      const igv = subtotal * 0.18;
      const total = subtotal + igv;

      const lines = cart.map(it => `
        <div class="summary-line">
          <span>${it.nombre} (x${it.cantidad})</span>
          <span>S/ ${money(it.precio * it.cantidad)}</span>
        </div>`).join('');

      summaryContent.innerHTML = `
        ${lines}
        <div class="summary-line" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
          <span>Subtotal</span><span>S/ ${money(subtotal)}</span>
        </div>
        <div class="summary-line">
          <span>IGV (18%)</span><span>S/ ${money(igv)}</span>
        </div>
        <div class="summary-line total">
          <span>TOTAL</span><span>S/ ${money(total)}</span>
        </div>`;
    }

    function goToMenu() { window.location.href = 'menu.html'; }

    // -------------------- Env√≠o al backend --------------------
    async function submitOrder() {
      if (!cart.length) {
        alert('El pedido est√° vac√≠o');
        return;
      }

      // Usuario que registra (obligatorio para backend)
      const idUsuario = localStorage.getItem('id_user') || localStorage.getItem('usuario') || localStorage.getItem('user');
      if (!idUsuario) {
        alert('No se encontr√≥ el id del usuario logueado. Aseg√∫rate de guardar id_user en localStorage al iniciar sesi√≥n.');
        return;
      }

      const tipoSel = document.getElementById('tipoPedido').value; // 'mesa' | 'llevar'
      const tipo = (tipoSel === 'llevar') ? 'Para Llevar' : 'Para Mesa';

      const mesaValue = document.getElementById('numeroMesa').value;
      if (!mesaValue && tipo === 'Para Mesa') {
        alert('Por favor seleccione una mesa');
        return;
      }

      const idMesa = mesaValue ? Number(mesaValue) : 0;

      // Validar que no pedimos m√°s que el stock (defensa final)
      for (const it of cart) {
        if (Number(it.cantidad) > Number(it.stock || 0)) {
          alert(`El producto "${it.nombre}" excede el stock disponible (${it.stock}).`);
          return;
        }
        if (it.nota && !soloLetrasEspacios(it.nota)) {
          alert(`La nota de "${it.nombre}" solo puede contener letras y espacios.`);
          return;
        }
      }

      // 1) Crear Pedido
      try {
        const pedidoResp = await fetch(`${API_BASE}/api/pedidos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            idMesa,
            idUsuario,
            estado: 'Ordenado',
            tipo
          })
        });

        if (!pedidoResp.ok) {
          const err = await safeJson(pedidoResp);
          throw new Error(err.error || 'No se pudo crear el pedido');
        }

        const pedido = await pedidoResp.json(); // {idPedido, ...}
        const idPedido = pedido.idPedido || pedido.id_pedido || pedido.id;
        if (!idPedido) throw new Error('El backend no devolvi√≥ id del pedido.');

        // 2) Registrar Detalles (uno por √≠tem)
        for (const it of cart) {
          const detallePayload = {
            idPedido: idPedido,
            idProducto: it.idProducto,                // llenado al enriquecer el carrito
            cant: Number(it.cantidad),
            precioUnitario: Number(it.precio),
            nota: (it.nota || "").trim()
          };

            // Ajusta la URL si tu controlador usa otra ruta:
          const detResp = await fetch(`${API_BASE}/api/detalles`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(detallePayload)
          });

          if (!detResp.ok) {
            const derr = await safeJson(detResp);
            throw new Error(derr.error || 'No se pudo registrar un detalle del pedido');
          }
        }

        // √âxito total
        alert('‚úÖ Pedido registrado correctamente');
        sessionStorage.removeItem('cart');
        window.location.href = 'dashboard.html';

      } catch (e) {
        console.error(e);
        alert('Error al registrar el pedido: ' + e.message);
      }
    }

    async function safeJson(resp) {
      try { return await resp.json(); } catch { return {}; }
    }

    // -------------------- Inicio --------------------
    window.onload = async () => {
      await loadMesas();
      onTipoChange();
      loadCart();
      await enrichCartWithBackend(); // obtiene idProducto & stock
      updateCartDisplay();
    };
  </script>
</body>
</html>
